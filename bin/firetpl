#!/usr/bin/env node
/*global XQCore:true */
var fs = require('fs'),
	path = require('path');

var mkdirp = require('mkdirp'),
	program = require('commander');

var FireTPL = require('../firetpl');

program.version('0.0.1')
	.usage('[options] <file ...>')
	.option('-o, --out <outfile>', 'Write precompiled file to <outfile>. If this option is not present write to STDOUT')
	.option('-a, --amd <path>', 'Precompile as AMD module. <path> is the FireTPL module path')
	.option('-c, --commonjs <path>', 'Precompile as CommonJS module. <path> is the FireTPL module path')
	.option('-d, --debug', 'Enable debug mode')
	.option('-p, --pretty', 'Prettify output')
	.option('-s, --scopeTags', 'Insert scope tags')
	.option('-f, --file', 'Read from file')
	.option('-v, --verbose', 'Output more infos')
	.parse(process.argv);

// console.log('Args', program.args);
var src = program.args[0],
	source = fs.readFileSync(src, 'utf8'),
	tplName = path.basename(src, path.extname(src));

//Set debug mode
FireTPL.debug = !!program.debug;

if (program.verbose) {
	console.log('Precompile ', program.args);
	console.log('---------- begin of source file ----------');
	console.log(source);
	console.log('---------- end of source file ----------');
	console.log('size: ', source.length, 'chars');
	console.log('');
	console.log('');
}


var options = {};

if (program.scopeTags) {
	options.scopeTags = true;
}

var precompiled = FireTPL.precompile(source, 'fire', options);

if (program.verbose) {
	console.log('---------- begin of precompiled file ----------');
	console.log(precompiled);
	console.log('---------- end of precompiled file ----------');
	console.log('size: ', precompiled.length, 'chars');
}

var beforeOut = function(str) {
	if (!program.pretty) {
		return str;
	}

	var indention = 0,
		out = '';

	var repeat = function(str, i) {
		var out = '';
		while (i > 0) {
			out += str;
			i--;
		}
		return out;
	};

	for (var i = 0; i < str.length; i++) {
		var c = str.charAt(i);
		
		if(c === '}' && str.charAt(i - 1) !== '{') {
			indention--;
			out += '\n' + repeat('\t', indention);
		}

		out += c;

		if (c === '{' && str.charAt(i + 1) !== '}') {
			indention++;
			out += '\n' + repeat('\t', indention);
		}
		else if(c === ';') {
			out += '\n' + repeat('\t', indention);
		}
	}

	return out;
};

var output = '';
if (program.commonjs) {
	output += 'var FireTPL = require(\'' + program.commonjs + '\');';
}
else if (program.amd) {
	output += 'define([\'' + program.amd + '\'], function(FireTPL) {';
}
else {
	output = '(function() {';
}

output += 'FireTPL.templateCache.' + tplName + '=function(data,scopes) {\n\tvar h=new FireTPL.Runtime();\n\t' + precompiled + '\n\treturn s;};';

if (program.commonjs) {

}
else if(program.amd) {
	output += '});';
}
else {
	output += '})();';
}

if (program.out) {
	console.log('Write to', program.out);
	var dir = path.dirname(program.out);
	if (dir) {
		mkdirp.sync(dir);
	}
	fs.writeFileSync(program.out, beforeOut(output));
} else {
	console.log(beforeOut(output));
}